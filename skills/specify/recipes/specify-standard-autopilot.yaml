name: specify-standard-autopilot
type: sequential
description: Full planning without user interaction (standard depth, autopilot mode)

blocks:
  - id: init
    type: cli
    command: "dev-cli init {name} --standard --autopilot"

  - id: classify-intent
    type: llm
    instruction: |
      Classify the user intent for this session. Choose the single best category:
        Feature / Bug / Refactor / Architecture / Migration / Performance / Research
      Output a short intent statement (1-2 sentences) naming the category and the goal.
    save: "dev-cli draft update {name} --section intent"

  - id: explore-full
    type: subagent
    agents:
      - type: Explore
        promptHint: "Find existing code patterns and prior implementations relevant to {name}"
        output: "findings/explore-1.md"
      - type: Explore
        promptHint: "Find project structure, commands, entry points, and dependency graph"
        output: "findings/explore-2.md"
      - type: docs-researcher
        promptHint: "Find ADRs, design documents, coding conventions, and known constraints"
        output: "findings/docs.md"
      - type: ux-reviewer
        promptHint: "Evaluate UX impact and surface usability concerns for {name}"
        output: "findings/ux.md"
    parallel: true
    onComplete: "dev-cli draft import {name}"
    onError: continue

  - id: auto-assume
    type: cli
    command: "dev-cli draft auto-assume {name}"

  - id: analyze-full
    type: subagent
    agents:
      - type: tradeoff-analyzer
        promptHint: "Analyze architectural trade-offs for {name} given the auto-assumed decisions"
        output: "analysis/tradeoff.md"
      - type: gap-analyzer
        promptHint: "Identify implementation gaps and missing context for {name}"
        output: "analysis/gaps.md"
      - type: simplicity-checker
        promptHint: "Evaluate the simplest viable approach for {name}"
        output: "analysis/simplicity.md"
      - type: risk-assessor
        promptHint: "Assess risks and unknowns for {name} before planning"
        output: "analysis/risks.md"
    parallel: true
    onComplete: "dev-cli draft import {name}"
    onError: continue

  - id: codex-synth
    type: subagent
    agents:
      - type: codex-strategist
        promptHint: "Synthesize exploration and analysis into a coherent implementation strategy for {name}"
        output: "analysis/strategy.md"
    onComplete: "dev-cli draft import {name}"

  - id: generate-plan
    type: llm+cli
    instruction: |
      Using all findings, auto-assumed decisions, analysis, and the synthesized strategy, write
      plan-content.json following this EXACT schema. Standard mode: comprehensive todos with
      detailed acceptance criteria, inputs/outputs, and verification items.

      Required JSON structure:
      {
        "context": {
          "originalRequest": "<user's original request>",
          "interviewSummary": "<summary of auto-assumed decisions>",
          "researchFindings": "<comprehensive findings from exploration and analysis>",
          "assumptions": "<optional: explicit assumptions>"
        },
        "objectives": {
          "core": "<single sentence core objective>",
          "deliverables": ["<concrete deliverable 1>", ...],
          "dod": ["<definition of done item>", ...],
          "mustNotDo": ["<explicit exclusion>", ...]
        },
        "todos": [
          {
            "id": "todo-1",
            "title": "<action title>",
            "type": "work|verification",
            "inputs": [{"name": "<input>", "type": "file|api|config", "ref": "<path or reference>"}],
            "outputs": [{"name": "<output>", "type": "file|api|config", "value": "<path>", "description": "<what it produces>"}],
            "steps": ["<step 1>", "<step 2>", ...],
            "mustNotDo": ["<what to avoid>"],
            "references": ["<relevant file or doc>"],
            "acceptanceCriteria": {
              "functional": ["<functional check>"],
              "static": ["<lint/type check>"],
              "runtime": ["<runtime check>"],
              "cleanup": ["<optional cleanup>"]
            },
            "risk": "LOW|MEDIUM|HIGH"
          }
        ],
        "taskFlow": "<text description of task execution order and parallelism>",
        "dependencyGraph": [
          {"todo": "todo-1", "requires": [], "produces": ["<artifact>"]}
        ],
        "commitStrategy": [
          {"afterTodo": "todo-1", "message": "<commit message>", "files": ["<file>"], "condition": "<when to commit>"}
        ],
        "verificationSummary": {
          "aItems": ["<agent-verifiable item>"],
          "hItems": ["<human-required item>"],
          "sItems": ["<sandbox testable item>"],
          "gaps": ["<verification gap if any>"]
        }
      }

      QUALITY RULES (mandatory):
      1. Each todo MUST have ≥3 functional acceptance criteria — specific, testable, not vague.
         BAD:  "Works correctly"
         GOOD: "Click button increments score by 1 and updates display"
      2. verificationSummary.aItems: each item MUST include verification method in parentheses.
         Example: "Script loads without errors (method: node --check or browser DevTools console)"
      3. verificationSummary.hItems: each item MUST explain WHY human verification is needed.
         Example: "UI layout looks correct (reason: visual inspection, no automated pixel comparison)"
      4. commitStrategy: NEVER leave empty. If no commits needed (e.g., git-ignored dir), add:
         [{"afterTodo":"todo-1","message":"N/A","files":[],"condition":"Directory is git-ignored, no commit needed"}]
      5. objectives.mustNotDo: minimum 3 items for standard mode — include scope guards, anti-patterns, and file protection.
      6. Each todo.steps: must be concrete actions with specific file paths, not categories.
         BAD:  "Implement game logic"
         GOOD: "Write game state machine (START/PLAYING/GAME_OVER) in .playground/breakout.html <script> section"
      7. taskFlow: describe execution order, parallelism, and dependency rationale.
      8. verificationSummary: standard mode requires ≥3 aItems AND ≥3 hItems.

      Write the JSON to plan-content.json file using the Write tool, then the CLI will validate and generate PLAN.md.
    command: "dev-cli plan generate {name} --data plan-content.json"

  - id: review-full
    type: subagent-loop
    agents:
      - type: plan-reviewer
        promptHint: "Review the plan for {name}: completeness, clarity, and feasibility"
        output: "analysis/review.md"
      - type: gap-analyzer
        promptHint: "Check the plan for {name} against the requirements for any remaining gaps"
        output: "analysis/review-gaps.md"
    maxRounds: 3
    exitWhen: "dev-cli plan validate {name}"

  - id: summary
    type: cli
    command: "dev-cli plan summary {name}"

  - id: cleanup
    type: cli
    command: "dev-cli cleanup {name}"
